# Reporte de Implementación - 07 de Enero de 2026
## Sistema Completo de Amistades, Solicitudes y Notificaciones

---

## Resumen Ejecutivo

Se ha implementado un sistema completo de gestión de amistades entre usuarios de tipo **Customer**, incluyendo solicitudes de amistad, notificaciones automáticas y gestión de la lista de amigos. La implementación incluye 8 nuevos endpoints, 3 entidades, 3 servicios, 2 controladores y 78 tests unitarios.

---

## Nuevas Funcionalidades

### 1. Sistema de Solicitudes de Amistad (Friend Requests)

Los usuarios de tipo `Customer` pueden enviar y gestionar solicitudes de amistad:

| Endpoint | Método | Descripción |
|----------|--------|-------------|
| `/users/{id}/friend-requests` | POST | Enviar solicitud de amistad |
| `/users/me/friend-requests` | GET | Obtener solicitudes pendientes recibidas |
| `/friend-requests/{id}/accept` | POST | Aceptar una solicitud |
| `/friend-requests/{id}/reject` | POST | Rechazar una solicitud |

### 2. Sistema de Amistades (Friendships)

Una vez aceptada una solicitud, se crea una amistad bidireccional:

| Endpoint | Método | Descripción |
|----------|--------|-------------|
| `/users/me/friends` | GET | Obtener lista de amigos |
| `/friends/{friendId}` | DELETE | Eliminar un amigo |

### 3. Sistema de Notificaciones

Notificaciones automáticas para eventos del sistema:

| Endpoint | Método | Descripción |
|----------|--------|-------------|
| `/users/me/notifications` | GET | Obtener todas las notificaciones |
| `/notifications/{id}/read` | POST | Marcar notificación como leída |

---

## Arquitectura Implementada

### Entidades Nuevas

```
┌─────────────────────────────────────────────────────────────────┐
│                          Request                                 │
├─────────────────────────────────────────────────────────────────┤
│ - id: Long                                                       │
│ - sender: User (ManyToOne)                                       │
│ - receiver: User (ManyToOne)                                     │
│ - requestType: RequestType (FRIEND_REQUEST)                      │
│ - status: RequestStatus (PENDING, ACCEPTED, REJECTED)            │
│ - createdAt: LocalDateTime                                       │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                         Friendship                               │
├─────────────────────────────────────────────────────────────────┤
│ - id: Long                                                       │
│ - userA: Customer (ManyToOne)                                    │
│ - userB: Customer (ManyToOne)                                    │
│ - createdAt: LocalDateTime                                       │
│ + involves(Customer): boolean                                    │
│ + getOtherUser(User): Customer                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        Notification                              │
├─────────────────────────────────────────────────────────────────┤
│ - id: Long                                                       │
│ - message: String                                                │
│ - date: LocalDateTime                                            │
│ - receiver: User (ManyToOne)                                     │
│ - request: Request (ManyToOne, nullable)                         │
│ - read: boolean                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Enums Nuevos

- **RequestType**: `FRIEND_REQUEST` (extensible para futuros tipos)
- **RequestStatus**: `PENDING`, `ACCEPTED`, `REJECTED`

### Servicios

| Servicio | Responsabilidad |
|----------|-----------------|
| `RequestService` | Gestión del ciclo de vida de solicitudes |
| `FriendshipService` | Gestión de amistades (crear, eliminar, consultar) |
| `NotificationService` | Creación y gestión de notificaciones |

### Controladores

| Controlador | Endpoints |
|-------------|-----------|
| `FriendController` | 6 endpoints para amistades y solicitudes |
| `NotificationController` | 2 endpoints para notificaciones |

---

## DTOs Implementados

| DTO | Campos Principales |
|-----|-------------------|
| `RequestDTO` | id, senderId, senderName, receiverId, receiverName, requestType, status, createdAt |
| `FriendDTO` | friendshipId, friendId, friendName, friendEmail, friendsSince |
| `NotificationDTO` | id, message, date, read, requestId |
| `FriendRequestCreateDTO` | receiverId |

---

## Excepciones Personalizadas

| Excepción | HTTP Status | Descripción |
|-----------|-------------|-------------|
| `SelfFriendRequestException` | 400 | Intento de enviarse solicitud a uno mismo |
| `DuplicateFriendRequestException` | 400 | Ya existe una solicitud pendiente |
| `FriendshipAlreadyExistsException` | 400 | Ya son amigos |
| `NotRequestReceiverException` | 400 | No es el receptor de la solicitud |
| `FriendshipNotFoundException` | 404 | No existe la amistad |

---

## Validaciones Implementadas

### Envío de Solicitud de Amistad
- ✅ No se puede enviar solicitud a uno mismo
- ✅ No se puede enviar si ya son amigos
- ✅ No se puede enviar si ya existe solicitud pendiente (en cualquier dirección)
- ✅ Solo usuarios tipo `Customer` pueden enviar solicitudes
- ✅ Solo se pueden enviar solicitudes a usuarios tipo `Customer`

### Aceptar/Rechazar Solicitud
- ✅ Solo el receptor puede aceptar/rechazar
- ✅ Solo solicitudes en estado `PENDING` pueden procesarse
- ✅ Al aceptar, se crea automáticamente la amistad

### Eliminar Amigo
- ✅ Verificación de que la amistad existe
- ✅ Cualquiera de los dos amigos puede eliminar la amistad

---

## Tests Implementados

### Tests de Controladores (35 tests)

**FriendControllerTest** - 28 tests organizados en 6 grupos:
- `SendFriendRequestTests` (6 tests)
- `GetPendingFriendRequestsTests` (4 tests)
- `AcceptFriendRequestTests` (5 tests)
- `RejectFriendRequestTests` (4 tests)
- `GetMyFriendsTests` (4 tests)
- `RemoveFriendTests` (5 tests)

**NotificationControllerTest** - 7 tests organizados en 2 grupos:
- `GetMyNotificationsTests` (5 tests)
- `MarkNotificationAsReadTests` (4 tests)

### Tests de Servicios (43 tests)

**RequestServiceTest** - 16 tests:
- `SendFriendRequestTests` (6 tests)
- `GetPendingFriendRequestsTests` (2 tests)
- `AcceptRequestTests` (4 tests)
- `RejectRequestTests` (4 tests)

**FriendshipServiceTest** - 12 tests:
- `GetFriendsTests` (3 tests)
- `AreFriendsTests` (3 tests)
- `CreateFriendshipTests` (2 tests)
- `RemoveFriendTests` (4 tests)

**NotificationServiceTest** - 15 tests:
- `CreateNotificationTests` (2 tests)
- `NotifyFriendRequestTests` (2 tests)
- `NotifyRequestAcceptedTests` (2 tests)
- `GetUserNotificationsTests` (2 tests)
- `GetUnreadNotificationsTests` (2 tests)
- `MarkAsReadTests` (3 tests)

---

## Flujo de Notificaciones

```
Usuario A envía solicitud → Usuario B recibe notificación:
  "Usuario A te ha enviado una solicitud de amistad"

Usuario B acepta solicitud → Usuario A recibe notificación:
  "Usuario B ha aceptado tu solicitud de amistad"
```

---

## Archivos Creados/Modificados

### Nuevos Archivos (23)

**Entidades:**
- `src/main/java/com/smartDine/entity/RequestType.java`
- `src/main/java/com/smartDine/entity/RequestStatus.java`
- `src/main/java/com/smartDine/entity/Request.java`
- `src/main/java/com/smartDine/entity/Friendship.java`
- `src/main/java/com/smartDine/entity/Notification.java`

**Repositorios:**
- `src/main/java/com/smartDine/repository/RequestRepository.java`
- `src/main/java/com/smartDine/repository/FriendshipRepository.java`
- `src/main/java/com/smartDine/repository/NotificationRepository.java`

**DTOs:**
- `src/main/java/com/smartDine/dto/RequestDTO.java`
- `src/main/java/com/smartDine/dto/FriendDTO.java`
- `src/main/java/com/smartDine/dto/NotificationDTO.java`
- `src/main/java/com/smartDine/dto/FriendRequestCreateDTO.java`

**Excepciones:**
- `src/main/java/com/smartDine/exceptions/SelfFriendRequestException.java`
- `src/main/java/com/smartDine/exceptions/DuplicateFriendRequestException.java`
- `src/main/java/com/smartDine/exceptions/FriendshipAlreadyExistsException.java`
- `src/main/java/com/smartDine/exceptions/NotRequestReceiverException.java`
- `src/main/java/com/smartDine/exceptions/FriendshipNotFoundException.java`

**Servicios:**
- `src/main/java/com/smartDine/services/RequestService.java`
- `src/main/java/com/smartDine/services/FriendshipService.java`
- `src/main/java/com/smartDine/services/NotificationService.java`

**Controladores:**
- `src/main/java/com/smartDine/controllers/FriendController.java`
- `src/main/java/com/smartDine/controllers/NotificationController.java`

**Tests:**
- `src/test/java/com/smartDine/controllers/FriendControllerTest.java`
- `src/test/java/com/smartDine/controllers/NotificationControllerTest.java`
- `src/test/java/com/smartDine/services/RequestServiceTest.java`
- `src/test/java/com/smartDine/services/FriendshipServiceTest.java`
- `src/test/java/com/smartDine/services/NotificationServiceTest.java`

### Archivos Modificados (2)

- `src/main/java/com/smartDine/handlers/GlobalExceptionHandler.java` - Añadidos 5 handlers para las nuevas excepciones
- `api.yaml` - Documentados los 8 nuevos endpoints y 3 nuevos schemas

---

## Resultado de Tests

```
Tests run: 265, Failures: 0, Errors: 0, Skipped: 0
BUILD SUCCESS
```

- **Tests totales del proyecto**: 265
- **Tests nuevos añadidos**: 78
- **Cobertura de escenarios**: Flujos felices + casos de error + validaciones

---

## Decisiones de Diseño

1. **Un solo controlador para amistades y solicitudes**: Se decidió usar `FriendController` para ambas funcionalidades por simplicidad.

2. **Business recibe notificaciones pero no solicitudes**: Los usuarios de tipo `Business` pueden recibir notificaciones generales, pero no pueden participar en el sistema de amistades.

3. **Sin paginación**: La lista de amigos y notificaciones no implementa paginación según requerimiento.

4. **Notificaciones automáticas**: Se generan automáticamente al enviar y aceptar solicitudes.

5. **Amistad bidireccional**: Una sola entrada en la tabla `Friendship` representa la relación entre ambos usuarios.

---

## Próximos Pasos Sugeridos

1. Añadir endpoint para obtener solo notificaciones no leídas
2. Implementar notificaciones push/websocket
3. Añadir búsqueda de usuarios para enviar solicitudes
4. Implementar bloqueo de usuarios
5. Añadir historial de solicitudes rechazadas

---

*Reporte generado automáticamente - SmartDine Backend*
